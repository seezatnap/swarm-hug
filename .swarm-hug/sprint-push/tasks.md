# Tasks

## Git Command Layer

- [x] (#1) Add `push_branch_to_remote()` in `src/git.rs` that executes `git push origin <target_branch>` via `std::process::Command` (without `--force`), captures exit status/stdout/stderr, and returns structured success/failure data usable by runner logic and tests [5 pts] (A)
- [x] (#2) Add `get_commit_log_between()` in `src/git.rs` that executes `git log --oneline <source_branch>..<target_branch>` and returns the output as a string for use in PR description generation [3 pts] (B)
- [x] (#3) Add `create_pull_request()` in `src/git.rs` that executes `gh pr create --title <title> --body <body> --base <source_branch> --head <target_branch>` via `std::process::Command`, captures stdout (the PR URL) and stderr, and returns structured success/failure data; before running, check that `gh` is on PATH (e.g. via `which gh`) and return early with a skip result if not found [5 pts] (A)

## Sprint Runner Flow

- [x] (#4) Update `src/runner.rs` after the `merged_ok` block to call push only when `config.target_branch` is explicitly `Some(...)`, the merge was not skipped (`sprint_branch != target_branch`), and shutdown was not requested; preserve current behavior when these conditions are not met [5 pts] (blocked by #1) (A)
- [x] (#5) Implement push outcome handling in `src/runner.rs`: on success print and record a push status message in merge logger/chat; on failure print a warning, log failure details for debugging, and continue returning sprint success because local merge already succeeded [5 pts] (blocked by #4) (A)
- [x] (#6) After a successful push in `src/runner.rs`, invoke the current sprint engine with a prompt containing the `get_commit_log_between()` output and asking it to return a JSON object with `"title"` and `"body"` keys for a pull request; parse the JSON from the engine output, falling back to default title `"[swarm] <target_branch>"` and body `"Auto-generated by swarm sprint."` if parsing fails [8 pts] (blocked by #2, #5) (A)
- [x] (#7) After obtaining PR title and body from the engine, call `create_pull_request()` with the parsed title, body, source branch, and target branch; on success print and log the PR URL; on failure (including `gh` not found) print a warning and continue without failing the sprint [5 pts] (blocked by #3, #6) (A)

## Testing

- [x] (#8) Add unit tests validating push invocation/skipping based on applicability rules: explicit `--target-branch` provided vs auto-detected default, merge-skipped path (`sprint_branch == target_branch`), and shutdown-requested path [5 pts] (blocked by #4) (B)
- [x] (#9) Add unit test coverage proving push failure is non-fatal to `run_sprint` (success still returned after local merge) and that warning/debug logging paths are exercised [5 pts] (blocked by #5) (A)
- [x] (#10) Add unit tests for `create_pull_request()`: verify the `gh pr create` command is formed with correct `--title`, `--body`, `--base`, `--head` flags; verify skip behavior when `gh` is not on PATH; verify failure is non-fatal [5 pts] (blocked by #3) (B)
- [x] (#11) Add an integration-style test verifying the full post-merge flow: push command is formed correctly, engine is invoked for PR generation, and `gh pr create` is called with the engine-derived title/body (or defaults on parse failure) [8 pts] (blocked by #6, #7) (A)

## Follow-up tasks (from sprint review)
- [x] (#12) Fix cross-platform test regression in `src/git.rs` by removing unconditional Unix-only APIs (`std::os::unix::fs::PermissionsExt` and `set_mode`) from the new PR-helper tests, using `#[cfg(unix)]` guards or a platform-neutral executable setup so `cargo check --tests --target x86_64-pc-windows-msvc` succeeds. (B)

## Follow-up tasks (from sprint review)
- [x] (#13) Update `src/runner.rs` push gating to use an explicit `--target-branch` signal (not `config.target_branch.is_some()` after branch resolution), so auto-detected/default and `--source-branch`-only runs do not execute `git push origin <target_branch>`. (A)

## Follow-up tasks (from sprint review)
- [x] (#14) Harden CLI parsing/validation for `--target-branch` so `target_branch_explicit` is set only when a real branch value is provided (not missing/another flag), and add tests proving malformed `--target-branch` input cannot trigger `git push origin <target_branch>`. (B)

## Follow-up tasks (from sprint review)
- [x] (#15) Make `create_pull_request()` use a cross-platform `gh` availability check (avoid hardcoded `which`, e.g. use `where` on Windows or probe `gh --version`) so PR creation is not incorrectly skipped on Windows; add unit tests for both success and missing-`gh` cases. (A)

## Follow-up tasks (from sprint review)
- [x] (#16) Replace the inline `git push` path in `run_sprint` with a git-layer helper that returns structured push results, and gate push on an explicit `--target-branch` signal (current `config.target_branch.is_some()` still pushes for source-only/auto-detected runs). (A)
- [x] (#17) Harden CLI parsing/validation for `--target-branch` so missing values cannot consume the next flag (for example, `--target-branch --no-tui`) and instead return a clear validation error. (B)
- [x] (#18) Record push outcomes in `files_chat` as `ScrumMaster` messages (success, failure, and skip), not only in merge logs/stdout. (A)
- [x] (#19) Add missing post-merge tests covering push skip paths (`sprint_branch == target_branch`, shutdown requested, and no explicit `--target-branch`), push-failure non-fatal behavior/logging, malformed `--target-branch` input, and engine-derived PR title/body propagation to `gh pr create`. (B)

## Follow-up tasks (from sprint review)
- [x] (#20) Restore cross-platform `gh` detection in `src/git.rs` `create_pull_request()` (current implementation hardcodes `which`, so Windows skips PR creation even when `gh` is installed), and add a regression test that exercises the Windows probe path. (A)
